# encoding: utf-8
# @author Kadvin, Date: 12-1-5
require File.join(File.dirname(__FILE__), "../", "prepare")
require "analysis/engine"
require "analysis/initializer"
require "analysis/rules/create_threshold"
describe "Analysis the log of create threshold" do

  before(:each) do
    @files = %W{ps_userpane.log se_commander.log se_scheduler.log}
    contents = {}
    File.stub(:open) do |file|
      contents[file].split("\n").map(&:strip)
    end
    contents["ps_userpane.log"] = <<-LOG
      10:29:21,036 DEBUG [http-bio-/0.0.0.0-8020-exec-8] ThresholdRulesController#getJsonFromBody ~ get json from body as {"eventType"=>"阈值事件.广域断线", "name"=>"测试规则-1-31", "stopOn"=>"2012-12-31", "schedulePlan"=>{"includes"=>[{"days_of_week"=>"1-5", "times"=>"8:30-12:00,14:00-17:30", "months"=>"1,2,3"}, {"days_of_month"=>"1-30", "times"=>"9:00-12:30,14:30-18:00", "months"=>"4,5,6,7,8,9,10"}], "excludes"=>[{"days_of_month"=>"1-7", "months"=>"10"}, {"days_of_week"=>"1", "months"=>"1"}, {"days_of_month"=>"1", "months"=>"5"}]}, "notification"=>{"repeatCount"=>3, "data"=>[{"destinationName"=>"BTIM.JMColor", "type"=>"poll", "description"=>"如保留个数等其他信息将在程序的配置中, 而不是存于规则中"}, {"destinationName"=>"BTIM.Alert", "type"=>"poll"}, {"destinationName"=>"http://127.0.0.1:1099/pushEvent", "type"=>"push"}, {"destinationName"=>"Nanri", "type"=>"jms", "description"=>"如jms地址端口等其他信息将在程序的配置中, 而不是存于规则中,暂时不支持"}, {"destinationName"=>"xxxx", "type"=>"jms", "description"=>"如jms地址端口等其他信息将在程序的配置中, 而不是存于规则中，暂时不支持"}, {"destinationName"=>"yyy", "type"=>"db", "description"=>"如jdbc的url等其他信息将在程序的配置中, 而不是存于规则中，暂时不支持"}]}, "creator"=>"PDM-PTS-CREATE-THRESHOLD", "trigger"=>{"condition"=>[{"label"=>"低", "value"=>"30", "operator"=>"<", "description"=>"描述信息1，可作为事件表述"}, {"label"=>"中", "value"=>"50", "operator"=>"<", "description"=>"描述信息2，可作为事件表述"}, {"label"=>"高", "value"=>"80", "operator"=>"<", "description"=>"描述信息3，可作为事件表述"}], "@type"=>"switch", "select"=>{"projection"=>{"function"=>"Count", "field"=>"ProcessMEM"}, "when"=>{"value"=>"betasoft.pdm.*", "operator"=>"like", "field"=>"ProcessName"}}}, "startOn"=>"2012-01-10", "indicator"=>{"expectedInterval"=>5000, "name"=>"RemotePing", "arguments"=>[{"a1"=>"executing-host"}, {"a2"=>23}, {"a2"=>{"SentPacketsSize"=>300, "SentPacketsNum"=>20, "dstIP"=>"10.11.12.13", "Timeout"=>2000, "Delay"=>2000, "@type"=>"RemotingPingParameter"}}]}, "version"=>1, "description"=>"这是我用来做测试的", "source"=>"PDM-UP", "status"=>true, "managedObject"=>"moKey = '0f212db1-76c1-4c1d-a2cc-dc09362169dc'"}
      10:29:21,036 INFO  [http-bio-/0.0.0.0-8020-exec-8] ThresholdRulesController#create ~ Creating ThresholdRule(name : `测试规则-1-31`).
      10:29:21,036 INFO  [http-bio-/0.0.0.0-8020-exec-8] SubscribeRule#createFromJson ~ Creating PsThresholdRule(id:`null`, key:`null`, name:`测试规则-1-31`) for MO(moKey : "0f212db1-76c1-4c1d-a2cc-dc09362169dc")
      10:29:21,052 INFO  [http-bio-/0.0.0.0-8020-exec-8] System#raiseEvent ~ Dispatching {"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:21 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"create","id":2147,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":32,"name":"测试规则-1-31","parent_id":3335,"parent_type":"thresholdRule","rule_key":"c0075508-62f6-449a-9c1b-b25973aa6cfd","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:21 AM"} to Engine(20.0.8.110)
      10:29:21,067 INFO  [http-bio-/0.0.0.0-8020-exec-8] System#raiseEvent ~ Dispatched {"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:21 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"create","id":2147,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":32,"name":"测试规则-1-31","parent_id":3335,"parent_type":"thresholdRule","rule_key":"c0075508-62f6-449a-9c1b-b25973aa6cfd","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:21 AM"} to Engine(20.0.8.110)
      10:29:21,067 INFO  [http-bio-/0.0.0.0-8020-exec-8] SubscribeRule#createFromJson ~ Created PsThresholdRule(id:`3335`, key:`c0075508-62f6-449a-9c1b-b25973aa6cfd`, name:`测试规则-1-31`) for MO(moKey : "0f212db1-76c1-4c1d-a2cc-dc09362169dc")
      10:29:21,067 INFO  [http-bio-/0.0.0.0-8020-exec-8] ThresholdRulesController#create ~ Created ThresholdRule(name : `测试规则-1-31`).
      10:29:21,098 DEBUG [http-bio-/0.0.0.0-8020-exec-8] ThresholdRulesController#getJsonFromBody ~ get json from body as {"eventType"=>"阈值事件.广域断线", "name"=>"测试规则-1-32", "stopOn"=>"2012-12-31", "schedulePlan"=>{"includes"=>[{"days_of_week"=>"1-5", "times"=>"8:30-12:00,14:00-17:30", "months"=>"1,2,3"}, {"days_of_month"=>"1-30", "times"=>"9:00-12:30,14:30-18:00", "months"=>"4,5,6,7,8,9,10"}], "excludes"=>[{"days_of_month"=>"1-7", "months"=>"10"}, {"days_of_week"=>"1", "months"=>"1"}, {"days_of_month"=>"1", "months"=>"5"}]}, "notification"=>{"repeatCount"=>3, "data"=>[{"destinationName"=>"BTIM.JMColor", "type"=>"poll", "description"=>"如保留个数等其他信息将在程序的配置中, 而不是存于规则中"}, {"destinationName"=>"BTIM.Alert", "type"=>"poll"}, {"destinationName"=>"http://127.0.0.1:1099/pushEvent", "type"=>"push"}, {"destinationName"=>"Nanri", "type"=>"jms", "description"=>"如jms地址端口等其他信息将在程序的配置中, 而不是存于规则中,暂时不支持"}, {"destinationName"=>"xxxx", "type"=>"jms", "description"=>"如jms地址端口等其他信息将在程序的配置中, 而不是存于规则中，暂时不支持"}, {"destinationName"=>"yyy", "type"=>"db", "description"=>"如jdbc的url等其他信息将在程序的配置中, 而不是存于规则中，暂时不支持"}]}, "creator"=>"PDM-PTS-CREATE-THRESHOLD", "trigger"=>{"condition"=>[{"label"=>"低", "value"=>"30", "operator"=>"<", "description"=>"描述信息1，可作为事件表述"}, {"label"=>"中", "value"=>"50", "operator"=>"<", "description"=>"描述信息2，可作为事件表述"}, {"label"=>"高", "value"=>"80", "operator"=>"<", "description"=>"描述信息3，可作为事件表述"}], "@type"=>"switch", "select"=>{"projection"=>{"function"=>"Count", "field"=>"ProcessMEM"}, "when"=>{"value"=>"betasoft.pdm.*", "operator"=>"like", "field"=>"ProcessName"}}}, "startOn"=>"2012-01-10", "indicator"=>{"expectedInterval"=>5000, "name"=>"RemotePing", "arguments"=>[{"a1"=>"executing-host"}, {"a2"=>23}, {"a2"=>{"SentPacketsSize"=>300, "SentPacketsNum"=>20, "dstIP"=>"10.11.12.13", "Timeout"=>2000, "Delay"=>2000, "@type"=>"RemotingPingParameter"}}]}, "version"=>1, "description"=>"这是我用来做测试的", "source"=>"PDM-UP", "status"=>true, "managedObject"=>"moKey = 'c4833a16-6726-4f5f-9f0e-7e7858eeb37f'"}
      10:29:21,114 INFO  [http-bio-/0.0.0.0-8020-exec-8] ThresholdRulesController#create ~ Creating ThresholdRule(name : `测试规则-1-32`).
      10:29:21,114 INFO  [http-bio-/0.0.0.0-8020-exec-8] SubscribeRule#createFromJson ~ Creating PsThresholdRule(id:`null`, key:`null`, name:`测试规则-1-32`) for MO(moKey : "c4833a16-6726-4f5f-9f0e-7e7858eeb37f")
      10:29:21,130 INFO  [http-bio-/0.0.0.0-8020-exec-8] System#raiseEvent ~ Dispatching {"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:21 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"create","id":2148,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":33,"name":"测试规则-1-32","parent_id":3336,"parent_type":"thresholdRule","rule_key":"6347a685-00de-4399-8679-ed0190f30aa9","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:21 AM"} to Engine(20.0.8.110)
      10:29:21,145 INFO  [http-bio-/0.0.0.0-8020-exec-8] System#raiseEvent ~ Dispatched {"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:21 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"create","id":2148,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":33,"name":"测试规则-1-32","parent_id":3336,"parent_type":"thresholdRule","rule_key":"6347a685-00de-4399-8679-ed0190f30aa9","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:21 AM"} to Engine(20.0.8.110)
      10:29:21,145 INFO  [http-bio-/0.0.0.0-8020-exec-8] SubscribeRule#createFromJson ~ Created PsThresholdRule(id:`3336`, key:`6347a685-00de-4399-8679-ed0190f30aa9`, name:`测试规则-1-32`) for MO(moKey : "c4833a16-6726-4f5f-9f0e-7e7858eeb37f")
      10:29:21,145 INFO  [http-bio-/0.0.0.0-8020-exec-8] ThresholdRulesController#create ~ Created ThresholdRule(name : `测试规则-1-32`).
    LOG
    contents["se_commander.log"] = <<-LOG
      10:29:21,052 INFO  [RMI TCP Connection(72)-20.0.8.110] MapMessageListener#onApplicationEvent ~ Receive '{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:21 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"create","id":2147,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":32,"name":"测试规则-1-31","parent_id":3335,"parent_type":"thresholdRule","rule_key":"c0075508-62f6-449a-9c1b-b25973aa6cfd","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:21 AM"}'
      10:29:21,067 INFO  [RMI TCP Connection(72)-20.0.8.110] EventBridge#onEvent ~ Publish '{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:21 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"create","id":2147,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":32,"name":"测试规则-1-31","parent_id":3335,"parent_type":"thresholdRule","rule_key":"c0075508-62f6-449a-9c1b-b25973aa6cfd","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:21 AM"}' to 'ruleEvent'
      10:29:21,067 INFO  [RMI TCP Connection(72)-20.0.8.110] MapMessageListener#onApplicationEvent ~ Process '{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:21 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"create","id":2147,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":32,"name":"测试规则-1-31","parent_id":3335,"parent_type":"thresholdRule","rule_key":"c0075508-62f6-449a-9c1b-b25973aa6cfd","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:21 AM"}' success
      10:29:21,130 INFO  [RMI TCP Connection(72)-20.0.8.110] MapMessageListener#onApplicationEvent ~ Receive '{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:21 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"create","id":2148,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":33,"name":"测试规则-1-32","parent_id":3336,"parent_type":"thresholdRule","rule_key":"6347a685-00de-4399-8679-ed0190f30aa9","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:21 AM"}'
      10:29:21,145 INFO  [RMI TCP Connection(72)-20.0.8.110] EventBridge#onEvent ~ Publish '{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:21 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"create","id":2148,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":33,"name":"测试规则-1-32","parent_id":3336,"parent_type":"thresholdRule","rule_key":"6347a685-00de-4399-8679-ed0190f30aa9","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:21 AM"}' to 'ruleEvent'
      10:29:21,145 INFO  [RMI TCP Connection(72)-20.0.8.110] MapMessageListener#onApplicationEvent ~ Process '{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:21 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"create","id":2148,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":33,"name":"测试规则-1-32","parent_id":3336,"parent_type":"thresholdRule","rule_key":"6347a685-00de-4399-8679-ed0190f30aa9","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:21 AM"}' success
     LOG
    contents["se_scheduler.log"] = <<-LOG
      10:29:22,565 INFO  [redis_queue_ruleEvent] Topic#onEvent ~ Receive 'cn.com.betasoft.pubsub.JsonMessageEvent[{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:21 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"create","id":2147,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":32,"name":"测试规则-1-31","parent_id":3335,"parent_type":"thresholdRule","rule_key":"c0075508-62f6-449a-9c1b-b25973aa6cfd","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:21 AM"}]' from 'ruleEvent'
      10:29:22,580 INFO  [redis_queue_ruleEvent] ThresholdManager#startRule ~ Starting 'SeThresholdRule(id:`3335`, key:`c0075508-62f6-449a-9c1b-b25973aa6cfd`, name:`测试规则-1-31`)'.
      10:29:22,580 WARN  [redis_queue_ruleEvent] ExecutorBase#initialize ~ Start SeThresholdRule(id:`3335`, key:`c0075508-62f6-449a-9c1b-b25973aa6cfd`, name:`测试规则-1-31`) failed, because of: Can't find [MO(moKey : "0f212db1-76c1-4c1d-a2cc-dc09362169dc"), '32'] ManagedObject instance from database.
      10:29:22,580 WARN  [redis_queue_ruleEvent] ExecutorBase#start ~ Start SeThresholdRule(id:`3335`, key:`c0075508-62f6-449a-9c1b-b25973aa6cfd`, name:`测试规则-1-31`) failed, because of: Can't find [MO(moKey : "0f212db1-76c1-4c1d-a2cc-dc09362169dc"), '32'] ManagedObject instance from database.
      10:29:22,580 INFO  [redis_queue_ruleEvent] ThresholdManager#startRule ~ Started 'SeThresholdRule(id:`3335`, key:`c0075508-62f6-449a-9c1b-b25973aa6cfd`, name:`测试规则-1-31`)' done.
      10:29:22,580 INFO  [redis_queue_ruleEvent] Topic#onEvent ~ Receive 'cn.com.betasoft.pubsub.JsonMessageEvent[{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:21 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"create","id":2148,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":33,"name":"测试规则-1-32","parent_id":3336,"parent_type":"thresholdRule","rule_key":"6347a685-00de-4399-8679-ed0190f30aa9","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:21 AM"}]' from 'ruleEvent'
      10:29:22,596 INFO  [redis_queue_ruleEvent] ThresholdManager#startRule ~ Starting 'SeThresholdRule(id:`3336`, key:`6347a685-00de-4399-8679-ed0190f30aa9`, name:`测试规则-1-32`)'.
      10:29:22,596 WARN  [redis_queue_ruleEvent] ExecutorBase#initialize ~ Start SeThresholdRule(id:`3336`, key:`6347a685-00de-4399-8679-ed0190f30aa9`, name:`测试规则-1-32`) failed, because of: Can't find [MO(moKey : "c4833a16-6726-4f5f-9f0e-7e7858eeb37f"), '33'] ManagedObject instance from database.
      10:29:22,596 WARN  [redis_queue_ruleEvent] ExecutorBase#start ~ Start SeThresholdRule(id:`3336`, key:`6347a685-00de-4399-8679-ed0190f30aa9`, name:`测试规则-1-32`) failed, because of: Can't find [MO(moKey : "c4833a16-6726-4f5f-9f0e-7e7858eeb37f"), '33'] ManagedObject instance from database.
      10:29:22,596 INFO  [redis_queue_ruleEvent] ThresholdManager#startRule ~ Started 'SeThresholdRule(id:`3336`, key:`6347a685-00de-4399-8679-ed0190f30aa9`, name:`测试规则-1-32`)' done.
    LOG
  end

  it "should find out all the user tasks and log records" do
    tasks = Analysis::Engine.analysis(@files) do |task|
      $stderr.puts
      task.output_as_csv $stderr
    end
    tasks.should have(2).items
    tasks.first.should have(14).log_records
  end
end