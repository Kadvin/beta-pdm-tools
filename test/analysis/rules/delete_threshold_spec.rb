# encoding: utf-8
# @author Kadvin, Date: 12-1-5
require File.join(File.dirname(__FILE__), "../", "prepare")
require "analysis/engine"
require "analysis/initializer"
require "analysis/rules/delete_threshold"
describe "Analysis the log of delete threshold" do

  before(:each) do
    @files = %W{ps_userpane.log se_commander.log se_scheduler.log}
    contents = {}
    File.stub(:open) do |file|
      contents[file].split("\n").map(&:strip)
    end
    contents["ps_userpane.log"] = <<-LOG
      10:32:51,168 INFO  [http-bio-/0.0.0.0-8020-exec-7] ThresholdRulesController#delete ~ Deleting ThresholdRule(key : `647a545b-c338-46bd-8c38-277089274b7d`)
      10:32:51,168 INFO  [http-bio-/0.0.0.0-8020-exec-7] System#raiseEvent ~ Dispatching {"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:17 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"delete","id":2079,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":76,"name":"测试规则-1-75","parent_id":3268,"parent_type":"thresholdRule","rule_key":"647a545b-c338-46bd-8c38-277089274b7d","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:17 AM"} to Engine(20.0.8.110)
      10:32:51,168 INFO  [http-bio-/0.0.0.0-8020-exec-7] System#raiseEvent ~ Dispatched {"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:17 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"delete","id":2079,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":76,"name":"测试规则-1-75","parent_id":3268,"parent_type":"thresholdRule","rule_key":"647a545b-c338-46bd-8c38-277089274b7d","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:17 AM"} to Engine(20.0.8.110)
      10:32:51,184 INFO  [http-bio-/0.0.0.0-8020-exec-7] ThresholdRulesController#delete ~ Deleted ThresholdRule(key : `647a545b-c338-46bd-8c38-277089274b7d`)
      10:32:51,215 INFO  [http-bio-/0.0.0.0-8020-exec-7] ThresholdRulesController#delete ~ Deleting ThresholdRule(key : `afe166cd-81a6-4ea9-89cf-746d71c12494`)
      10:32:51,230 INFO  [http-bio-/0.0.0.0-8020-exec-7] System#raiseEvent ~ Dispatching {"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:17 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"delete","id":2080,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":9,"name":"测试规则-1-8","parent_id":3267,"parent_type":"thresholdRule","rule_key":"afe166cd-81a6-4ea9-89cf-746d71c12494","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:17 AM"} to Engine(20.0.8.110)
      10:32:51,246 INFO  [http-bio-/0.0.0.0-8020-exec-7] System#raiseEvent ~ Dispatched {"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:17 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"delete","id":2080,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":9,"name":"测试规则-1-8","parent_id":3267,"parent_type":"thresholdRule","rule_key":"afe166cd-81a6-4ea9-89cf-746d71c12494","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:17 AM"} to Engine(20.0.8.110)
      10:32:51,246 INFO  [http-bio-/0.0.0.0-8020-exec-7] ThresholdRulesController#delete ~ Deleted ThresholdRule(key : `afe166cd-81a6-4ea9-89cf-746d71c12494`)
    LOG
    contents["se_commander.log"] = <<-LOG
      10:32:51,168 INFO  [RMI TCP Connection(157)-20.0.8.110] MapMessageListener#onApplicationEvent ~ Receive '{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:17 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"delete","id":2079,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":76,"name":"测试规则-1-75","parent_id":3268,"parent_type":"thresholdRule","rule_key":"647a545b-c338-46bd-8c38-277089274b7d","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:17 AM"}'
      10:32:51,168 INFO  [RMI TCP Connection(157)-20.0.8.110] EventBridge#onEvent ~ Publish '{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:17 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"delete","id":2079,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":76,"name":"测试规则-1-75","parent_id":3268,"parent_type":"thresholdRule","rule_key":"647a545b-c338-46bd-8c38-277089274b7d","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:17 AM"}' to 'ruleEvent'
      10:32:51,168 INFO  [RMI TCP Connection(157)-20.0.8.110] MapMessageListener#onApplicationEvent ~ Process '{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:17 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"delete","id":2079,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":76,"name":"测试规则-1-75","parent_id":3268,"parent_type":"thresholdRule","rule_key":"647a545b-c338-46bd-8c38-277089274b7d","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:17 AM"}' success
      10:32:51,246 INFO  [RMI TCP Connection(159)-20.0.8.110] MapMessageListener#onApplicationEvent ~ Receive '{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:17 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"delete","id":2080,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":9,"name":"测试规则-1-8","parent_id":3267,"parent_type":"thresholdRule","rule_key":"afe166cd-81a6-4ea9-89cf-746d71c12494","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:17 AM"}'
      10:32:51,246 INFO  [RMI TCP Connection(159)-20.0.8.110] EventBridge#onEvent ~ Publish '{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:17 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"delete","id":2080,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":9,"name":"测试规则-1-8","parent_id":3267,"parent_type":"thresholdRule","rule_key":"afe166cd-81a6-4ea9-89cf-746d71c12494","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:17 AM"}' to 'ruleEvent'
      10:32:51,246 INFO  [RMI TCP Connection(159)-20.0.8.110] MapMessageListener#onApplicationEvent ~ Process '{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:17 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"delete","id":2080,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":9,"name":"测试规则-1-8","parent_id":3267,"parent_type":"thresholdRule","rule_key":"afe166cd-81a6-4ea9-89cf-746d71c12494","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:17 AM"}' success
    LOG
    contents["se_scheduler.log"] = <<-LOG
      10:32:51,168 INFO  [redis_queue_ruleEvent] Topic#onEvent ~ Receive 'cn.com.betasoft.pubsub.JsonMessageEvent[{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:17 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"delete","id":2079,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":76,"name":"测试规则-1-75","parent_id":3268,"parent_type":"thresholdRule","rule_key":"647a545b-c338-46bd-8c38-277089274b7d","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:17 AM"}]' from 'ruleEvent'
      10:32:51,168 INFO  [redis_queue_ruleEvent] ThresholdManager#stopRule ~ Stopping 'SeThresholdRule(id:`3268`, key:`647a545b-c338-46bd-8c38-277089274b7d`, name:`测试规则-1-75`)'.
      10:32:51,168 INFO  [redis_queue_ruleEvent] ThresholdManager#stopRule ~ Stopped 'SeThresholdRule(id:`3268`, key:`647a545b-c338-46bd-8c38-277089274b7d`, name:`测试规则-1-75`)' is done.
      10:32:51,246 INFO  [redis_queue_ruleEvent] Topic#onEvent ~ Receive 'cn.com.betasoft.pubsub.JsonMessageEvent[{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 10:29:17 AM","creator":"PDM-PTS-CREATE-THRESHOLD","description":"这是我用来做测试的","eventType":"delete","id":2080,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":9,"name":"测试规则-1-8","parent_id":3267,"parent_type":"thresholdRule","rule_key":"afe166cd-81a6-4ea9-89cf-746d71c12494","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 10:29:17 AM"}]' from 'ruleEvent'
      10:32:51,246 INFO  [redis_queue_ruleEvent] ThresholdManager#stopRule ~ Stopping 'SeThresholdRule(id:`3267`, key:`afe166cd-81a6-4ea9-89cf-746d71c12494`, name:`测试规则-1-8`)'.
      10:32:51,246 INFO  [redis_queue_ruleEvent] ThresholdManager#stopRule ~ Stopped 'SeThresholdRule(id:`3267`, key:`afe166cd-81a6-4ea9-89cf-746d71c12494`, name:`测试规则-1-8`)' is done.
    LOG
  end

  it "should find out all the user tasks and log records" do
    tasks = Analysis::Engine.analysis(@files) do |task|
      $stderr.puts
      task.output_as_csv $stderr
    end
    tasks.should have(2).items
    tasks.first.should have(10).log_records
  end
end