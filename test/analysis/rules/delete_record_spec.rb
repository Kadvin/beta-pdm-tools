# encoding: utf-8
# @author Kadvin, Date: 12-1-5
require File.join(File.dirname(__FILE__), "../", "prepare")
require "analysis/engine"
require "analysis/initializer"
require "analysis/rules/delete_record"
describe "Analysis the log of delete record" do

  before(:each) do
    @files = %W{ps_userpane.log se_commander.log se_scheduler.log}
    contents = {}
    File.stub(:open) do |file|
      contents[file].split("\n").map(&:strip)
    end
    contents["ps_userpane.log"] = <<-LOG
      14:38:50,213 INFO  [http-bio-/0.0.0.0-8020-exec-7] RecordRulesController#delete ~ Deleting RecordRule(key : `d3e338a5-7ccb-47ce-97b2-1c293f954ce9`).
      14:38:50,228 INFO  [http-bio-/0.0.0.0-8020-exec-7] System#raiseEvent ~ Dispatching {"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 2:24:10 PM","creator":"PDM-PTS-CREATE-RECORD","description":"这是我用来做测试的","eventType":"delete","id":191,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":86,"name":"测试记录规则-1-85","parent_id":63,"parent_type":"recordRule","rule_key":"d3e338a5-7ccb-47ce-97b2-1c293f954ce9","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 2:24:10 PM"} to Engine(20.0.8.110)
      14:38:50,228 INFO  [http-bio-/0.0.0.0-8020-exec-7] System#raiseEvent ~ Dispatched {"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 2:24:10 PM","creator":"PDM-PTS-CREATE-RECORD","description":"这是我用来做测试的","eventType":"delete","id":191,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":86,"name":"测试记录规则-1-85","parent_id":63,"parent_type":"recordRule","rule_key":"d3e338a5-7ccb-47ce-97b2-1c293f954ce9","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 2:24:10 PM"} to Engine(20.0.8.110)
      14:38:50,244 INFO  [http-bio-/0.0.0.0-8020-exec-7] RecordRulesController#delete ~ Deleted RecordRule(key : `d3e338a5-7ccb-47ce-97b2-1c293f954ce9`).
      14:38:50,275 INFO  [http-bio-/0.0.0.0-8020-exec-7] RecordRulesController#delete ~ Deleting RecordRule(key : `64a4e9cb-04f5-426e-981c-fd77c7a2c6d5`).
      14:38:50,291 INFO  [http-bio-/0.0.0.0-8020-exec-7] System#raiseEvent ~ Dispatching {"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 2:24:10 PM","creator":"PDM-PTS-CREATE-RECORD","description":"这是我用来做测试的","eventType":"delete","id":192,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":50,"name":"测试记录规则-1-49","parent_id":65,"parent_type":"recordRule","rule_key":"64a4e9cb-04f5-426e-981c-fd77c7a2c6d5","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 2:24:10 PM"} to Engine(20.0.8.110)
      14:38:50,291 INFO  [http-bio-/0.0.0.0-8020-exec-7] System#raiseEvent ~ Dispatched {"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 2:24:10 PM","creator":"PDM-PTS-CREATE-RECORD","description":"这是我用来做测试的","eventType":"delete","id":192,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":50,"name":"测试记录规则-1-49","parent_id":65,"parent_type":"recordRule","rule_key":"64a4e9cb-04f5-426e-981c-fd77c7a2c6d5","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 2:24:10 PM"} to Engine(20.0.8.110)
      14:38:50,306 INFO  [http-bio-/0.0.0.0-8020-exec-7] RecordRulesController#delete ~ Deleted RecordRule(key : `64a4e9cb-04f5-426e-981c-fd77c7a2c6d5`).
    LOG
    contents["se_commander.log"] = <<-LOG
      14:38:50,228 INFO  [RMI TCP Connection(180)-20.0.8.110] MapMessageListener#onApplicationEvent ~ Receive '{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 2:24:10 PM","creator":"PDM-PTS-CREATE-RECORD","description":"这是我用来做测试的","eventType":"delete","id":191,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":86,"name":"测试记录规则-1-85","parent_id":63,"parent_type":"recordRule","rule_key":"d3e338a5-7ccb-47ce-97b2-1c293f954ce9","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 2:24:10 PM"}'
      14:38:50,228 INFO  [RMI TCP Connection(180)-20.0.8.110] EventBridge#onEvent ~ Publish '{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 2:24:10 PM","creator":"PDM-PTS-CREATE-RECORD","description":"这是我用来做测试的","eventType":"delete","id":191,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":86,"name":"测试记录规则-1-85","parent_id":63,"parent_type":"recordRule","rule_key":"d3e338a5-7ccb-47ce-97b2-1c293f954ce9","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 2:24:10 PM"}' to 'ruleEvent'
      14:38:50,228 INFO  [RMI TCP Connection(180)-20.0.8.110] MapMessageListener#onApplicationEvent ~ Process '{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 2:24:10 PM","creator":"PDM-PTS-CREATE-RECORD","description":"这是我用来做测试的","eventType":"delete","id":191,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":86,"name":"测试记录规则-1-85","parent_id":63,"parent_type":"recordRule","rule_key":"d3e338a5-7ccb-47ce-97b2-1c293f954ce9","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 2:24:10 PM"}' success
      14:38:50,291 INFO  [RMI TCP Connection(180)-20.0.8.110] MapMessageListener#onApplicationEvent ~ Receive '{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 2:24:10 PM","creator":"PDM-PTS-CREATE-RECORD","description":"这是我用来做测试的","eventType":"delete","id":192,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":50,"name":"测试记录规则-1-49","parent_id":65,"parent_type":"recordRule","rule_key":"64a4e9cb-04f5-426e-981c-fd77c7a2c6d5","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 2:24:10 PM"}'
      14:38:50,291 INFO  [RMI TCP Connection(180)-20.0.8.110] EventBridge#onEvent ~ Publish '{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 2:24:10 PM","creator":"PDM-PTS-CREATE-RECORD","description":"这是我用来做测试的","eventType":"delete","id":192,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":50,"name":"测试记录规则-1-49","parent_id":65,"parent_type":"recordRule","rule_key":"64a4e9cb-04f5-426e-981c-fd77c7a2c6d5","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 2:24:10 PM"}' to 'ruleEvent'
      14:38:50,291 INFO  [RMI TCP Connection(180)-20.0.8.110] MapMessageListener#onApplicationEvent ~ Process '{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 2:24:10 PM","creator":"PDM-PTS-CREATE-RECORD","description":"这是我用来做测试的","eventType":"delete","id":192,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":50,"name":"测试记录规则-1-49","parent_id":65,"parent_type":"recordRule","rule_key":"64a4e9cb-04f5-426e-981c-fd77c7a2c6d5","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 2:24:10 PM"}' success
    LOG
    contents["se_scheduler.log"] = <<-LOG
          14:38:50,166 ERROR [redis_queue_ruleEvent] RuleScheduler#raiseException ~ Process '[cn.com.betasoft.pubsub.MapMessageEvent[source=PDM-UP], java.lang.reflect.InvocationTargetException, delete]' failed, because of: java.lang.reflect.InvocationTargetException.
          14:38:50,228 INFO  [redis_queue_ruleEvent] Topic#onEvent ~ Receive 'cn.com.betasoft.pubsub.JsonMessageEvent[{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 2:24:10 PM","creator":"PDM-PTS-CREATE-RECORD","description":"这是我用来做测试的","eventType":"delete","id":191,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":86,"name":"测试记录规则-1-85","parent_id":63,"parent_type":"recordRule","rule_key":"d3e338a5-7ccb-47ce-97b2-1c293f954ce9","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 2:24:10 PM"}]' from 'ruleEvent'
          14:38:50,228 INFO  [redis_queue_ruleEvent] RecordManager#stopRule ~ Stopping 'SeRecordRule(id:`63`, key:`d3e338a5-7ccb-47ce-97b2-1c293f954ce9`, name:`测试记录规则-1-85`)'.
          14:38:50,228 ERROR [redis_queue_ruleEvent] RecordManager#stopRule ~ Stop 'SeRecordRule(id:`63`, key:`d3e338a5-7ccb-47ce-97b2-1c293f954ce9`, name:`测试记录规则-1-85`)' failed, because of: null.
          java.lang.NullPointerException
            at cn.com.betasoft.dsat.se.record.RecordExecutor.internalStop(RecordExecutor.java:193)
            at cn.com.betasoft.dsat.se.ExecutorBase.stop(ExecutorBase.java:244)
            at cn.com.betasoft.dsat.se.ExecutorManager.stopRule(ExecutorManager.java:91)
            at cn.com.betasoft.dsat.se.ExecutorManager.onDelete(ExecutorManager.java:116)
            at cn.com.betasoft.dsat.se.scheduler.RuleScheduler.onDelete(RuleScheduler.java:54)
            at sun.reflect.GeneratedMethodAccessor11.invoke(Unknown Source)
            at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
            at java.lang.reflect.Method.invoke(Method.java:597)
            at cn.com.betasoft.pubsub.EventDispatcher.invokeMethod(EventDispatcher.java:56)
            at cn.com.betasoft.pubsub.EventDispatcher.onEvent(EventDispatcher.java:45)
            at cn.com.betasoft.pubsub.EventTransformer.onEvent(EventTransformer.java:27)
            at cn.com.betasoft.pubsub.SimpleTopic.onEvent(SimpleTopic.java:42)
            at cn.com.betasoft.pubsub.RedisEventManager$JedisPubSubClient.onMessage(RedisEventManager.java:126)
            at redis.clients.jedis.JedisPubSub.process(JedisPubSub.java:100)
            at redis.clients.jedis.JedisPubSub.proceed(JedisPubSub.java:70)
            at redis.clients.jedis.Jedis.subscribe(Jedis.java:2021)
            at cn.com.betasoft.pubsub.RedisEventManager$JedisPubSubClient.run(RedisEventManager.java:111)
            at java.lang.Thread.run(Thread.java:662)
          14:38:50,228 ERROR [redis_queue_ruleEvent] RuleScheduler#raiseException ~ Process '[cn.com.betasoft.pubsub.MapMessageEvent[source=PDM-UP], java.lang.reflect.InvocationTargetException, delete]' failed, because of: java.lang.reflect.InvocationTargetException.
          14:38:50,291 INFO  [redis_queue_ruleEvent] Topic#onEvent ~ Receive 'cn.com.betasoft.pubsub.JsonMessageEvent[{"arguments":"{ \"@Type\":\"fixedRate\", \"startOn\":\"2012-01-10\", \"endOn\":\"2012-12-31\", \"interval\":5000, \"activeTimes\":{\"includes\":[{\"days_of_week\":\"1-5\",\"times\":\"8:30-12:00,14:00-17:30\",\"months\":\"1,2,3\"},{\"days_of_month\":\"1-30\",\"times\":\"9:00-12:30,14:30-18:00\",\"months\":\"4,5,6,7,8,9,10\"}],\"excludes\":[{\"days_of_month\":\"1-7\",\"months\":\"10\"},{\"days_of_week\":\"1\",\"months\":\"1\"},{\"days_of_month\":\"1\",\"months\":\"5\"}]}}","channel":"ruleEvent","created_at":"Jan 16, 2012 2:24:10 PM","creator":"PDM-PTS-CREATE-RECORD","description":"这是我用来做测试的","eventType":"delete","id":192,"indicator":"RemotePing","indicator_arguments":"{}","managed_object_id":50,"name":"测试记录规则-1-49","parent_id":65,"parent_type":"recordRule","rule_key":"64a4e9cb-04f5-426e-981c-fd77c7a2c6d5","source":"PDM-UP","source_version":0,"status":1,"style":"fixedRate","table":"schedulable_rules","updated_at":"Jan 16, 2012 2:24:10 PM"}]' from 'ruleEvent'
          14:38:50,291 INFO  [redis_queue_ruleEvent] RecordManager#stopRule ~ Stopping 'SeRecordRule(id:`65`, key:`64a4e9cb-04f5-426e-981c-fd77c7a2c6d5`, name:`测试记录规则-1-49`)'.
          14:38:50,291 ERROR [redis_queue_ruleEvent] RecordManager#stopRule ~ Stop 'SeRecordRule(id:`65`, key:`64a4e9cb-04f5-426e-981c-fd77c7a2c6d5`, name:`测试记录规则-1-49`)' failed, because of: null.
          java.lang.NullPointerException
            at cn.com.betasoft.dsat.se.record.RecordExecutor.internalStop(RecordExecutor.java:193)
            at cn.com.betasoft.dsat.se.ExecutorBase.stop(ExecutorBase.java:244)
            at cn.com.betasoft.dsat.se.ExecutorManager.stopRule(ExecutorManager.java:91)
            at cn.com.betasoft.dsat.se.ExecutorManager.onDelete(ExecutorManager.java:116)
            at cn.com.betasoft.dsat.se.scheduler.RuleScheduler.onDelete(RuleScheduler.java:54)
            at sun.reflect.GeneratedMethodAccessor11.invoke(Unknown Source)
            at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
            at java.lang.reflect.Method.invoke(Method.java:597)
            at cn.com.betasoft.pubsub.EventDispatcher.invokeMethod(EventDispatcher.java:56)
            at cn.com.betasoft.pubsub.EventDispatcher.onEvent(EventDispatcher.java:45)
    LOG
  end

  it "should find out all the user tasks and log records" do
    tasks = Analysis::Engine.analysis(@files) do |task|
      $stderr.puts
      task.output_as_csv $stderr
    end
    tasks.should have(2).items
    tasks.first.should have(9).log_records
  end
end